<!-- accounts/templates/accounts/swipe_profiles.html -->
{% extends 'accounts/base.html' %}

{% block title %}Swipe Profiles{% endblock %}

{% block content %}
<div class="flex flex-col items-center justify-center min-h-[calc(100vh-200px)] p-4">
    <div id="profile-card-container" class="relative w-full max-w-sm h-[500px] flex items-center justify-center">
        {# This section is now rendered by the partial template when fetched via AJAX #}
        {% include 'accounts/includes/profile_card_partial.html' %}
    </div>

    {# Swipe Action Buttons (Optional, but good for non-touch/accuracy) #}
    {# Buttons are initially shown or hidden based on whether an initial profile exists #}
    <div class="mt-8 flex space-x-6 {% if not profile %}hidden{% endif %}" id="swipe-buttons">
        <button id="dislike-btn" class="btn btn-secondary text-2xl p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-200">
            ❌
        </button>
        <button id="like-btn" class="btn btn-primary text-2xl p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-200">
            ❤️
        </button>
    </div>
</div>

{% endblock content %} {# THIS CLOSES THE MAIN CONTENT BLOCK #}

{% block extra_js %}
<script>
    console.log('>>> swipe_profiles.html script started <<<'); // Initial debug log

    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOMContentLoaded fired.");

        const profileCardContainer = document.getElementById('profile-card-container');
        const dislikeBtn = document.getElementById('dislike-btn');
        const likeBtn = document.getElementById('like-btn');
        const swipeButtonsDiv = document.getElementById('swipe-buttons');

        let profileCard; // Will be reassigned on each rebind
        let likeOverlay; // New: Reference for LIKE overlay
        let nopeOverlay; // New: Reference for NOPE overlay

        let startX, startY, currentX, currentY, dragging = false;
        const THRESHOLD = 100; // Pixels to swipe before it's considered a like/dislike
        const MAX_ROTATION = 15; // Max degrees for card rotation
        const OVERLAY_TRIGGER_THRESHOLD = 50; // Pixels before overlay starts appearing

        /**
         * Rebinds event listeners and element references to the profile card and action buttons.
         * This is crucial because the profile card element is replaced after each swipe.
         */
        function rebindEventListeners() {
            // Re-select the current profile card and overlays from the DOM
            profileCard = document.getElementById('profile-card'); 
            likeOverlay = document.getElementById('like-overlay'); // New
            nopeOverlay = document.getElementById('nope-overlay'); // New
            console.log("rebindEventListeners: profileCard re-selected:", profileCard);
            console.log("rebindEventListeners: likeOverlay:", likeOverlay, "nopeOverlay:", nopeOverlay);


            if (!profileCard) {
                console.log("rebindEventListeners: No profile card found. Hiding buttons.");
                if (swipeButtonsDiv) swipeButtonsDiv.classList.add('hidden'); 
                return;
            } else {
                console.log("rebindEventListeners: Profile card found. Ensuring buttons are visible.");
                if (swipeButtonsDiv) swipeButtonsDiv.classList.remove('hidden'); 
            }

            // Remove existing listeners from the OLD card (if any) to prevent duplicates
            // Ensure we only remove if profileCard is not null
            if (profileCard.listenersAttached) { // Custom flag to track if listeners were attached
                 profileCard.removeEventListener('mousedown', onStart);
                 profileCard.removeEventListener('mousemove', onMove);
                 profileCard.removeEventListener('mouseup', onEnd);
                 profileCard.removeEventListener('touchstart', onStart);
                 profileCard.removeEventListener('touchmove', onMove);
                 profileCard.removeEventListener('touchend', onEnd);
                 console.log("rebindEventListeners: Removed old event listeners.");
            }

            // Add new listeners to the *current* profileCard
            profileCard.addEventListener('mousedown', onStart);
            profileCard.addEventListener('mousemove', onMove);
            profileCard.addEventListener('mouseup', onEnd);
            profileCard.addEventListener('touchstart', onStart, { passive: false }); // passive: false to allow e.preventDefault()
            profileCard.addEventListener('touchmove', onMove, { passive: false }); // passive: false to allow e.preventDefault()
            profileCard.addEventListener('touchend', onEnd);
            profileCard.listenersAttached = true; // Set custom flag
            console.log("rebindEventListeners: Swipe event listeners re-attached to new card.");

            // Rebind action buttons
            if (dislikeBtn) {
                dislikeBtn.onclick = null; // Remove previous handler
                dislikeBtn.onclick = () => {
                    console.log("Dislike button clicked.");
                    performAction('dislike');
                    animateSwipe('left', fetchNextProfile);
                };
            }
            if (likeBtn) {
                likeBtn.onclick = null; // Remove previous handler
                likeBtn.onclick = () => {
                    console.log("Like button clicked.");
                    performAction('like');
                    animateSwipe('right', fetchNextProfile);
                };
            }
        }

        // Initialize event listeners on page load for the initial card
        rebindEventListeners();
        console.log("Initial rebindEventListeners call completed.");

        // Functions to apply/reset styles
        function resetCard() {
            if (profileCard) {
                profileCard.style.transition = 'transform 0.3s ease-out';
                profileCard.style.transform = 'translate(0px, 0px) rotate(0deg)';
                profileCard.style.opacity = '1';
                console.log("resetCard: Card reset to original position.");
            }
            // Hide overlays
            if (likeOverlay) likeOverlay.style.opacity = '0';
            if (nopeOverlay) nopeOverlay.style.opacity = '0';
        }

        function animateSwipe(direction, onComplete) {
            if (!profileCard) {
                console.warn("animateSwipe: No profile card to animate.");
                if (onComplete) onComplete();
                return;
            }
            profileCard.style.transition = 'transform 0.5s ease-out, opacity 0.5s ease-out';
            let translateX = 0;
            let rotateZ = 0;
            let finalOpacity = 0; // Card fades out

            if (direction === 'left') {
                translateX = -window.innerWidth * 1.5; // Swipe further off-screen
                rotateZ = -MAX_ROTATION * 2; // Exaggerate rotation for animation
                if (nopeOverlay) nopeOverlay.style.opacity = '1'; // Ensure overlay is visible during final animation
                if (likeOverlay) likeOverlay.style.opacity = '0'; // Hide other overlay
                console.log("animateSwipe: Animating left (dislike).");
            } else if (direction === 'right') {
                translateX = window.innerWidth * 1.5; // Swipe further off-screen
                rotateZ = MAX_ROTATION * 2; // Exaggerate rotation for animation
                if (likeOverlay) likeOverlay.style.opacity = '1'; // Ensure overlay is visible during final animation
                if (nopeOverlay) nopeOverlay.style.opacity = '0'; // Hide other overlay
                console.log("animateSwipe: Animating right (like).");
            }

            profileCard.style.transform = `translate(${translateX}px, ${currentY - startY}px) rotate(${rotateZ}deg)`;
            profileCard.style.opacity = finalOpacity;

            profileCard.addEventListener('transitionend', function handler() {
                profileCard.removeEventListener('transitionend', handler);
                console.log("animateSwipe: Transition ended.");
                if (onComplete) onComplete();
            }, { once: true });
        }

        // --- Event Handlers for Swiping ---
        function onStart(e) {
            dragging = true;
            if (profileCard) {
                profileCard.style.transition = 'none'; // Disable transition during drag
                console.log("onStart: Dragging started, transition disabled.");
            }
            // Get clientX/Y from event (handles both mouse and touch)
            startX = e.clientX || e.touches[0].clientX;
            startY = e.clientY || e.touches[0].clientY;
            // console.log(`onStart: Start at (${startX}, ${startY})`); // Too verbose
        }

        function onMove(e) {
            if (!dragging || !profileCard) return;
            // Prevent scrolling on touch devices while dragging horizontally
            if (e.type === 'touchmove') e.preventDefault(); 
            
            currentX = e.clientX || e.touches[0].clientX;
            currentY = e.clientY || e.touches[0].clientY;
            const deltaX = currentX - startX;
            const deltaY = currentY - startY; // Keep deltaY for slight vertical movement
            
            // Calculate rotation based on horizontal drag distance
            const rotation = deltaX / 20; 
            const clampedRotation = Math.max(-MAX_ROTATION, Math.min(MAX_ROTATION, rotation));

            profileCard.style.transform = `translate(${deltaX}px, ${deltaY}px) rotate(${clampedRotation}deg)`;

            // New: Control overlay opacity
            const absDeltaX = Math.abs(deltaX);
            let overlayOpacity = 0;
            if (absDeltaX > OVERLAY_TRIGGER_THRESHOLD) {
                // Fade in opacity as swipe distance increases, max at 1
                overlayOpacity = Math.min(1, (absDeltaX - OVERLAY_TRIGGER_THRESHOLD) / (THRESHOLD * 2));
            }
            
            if (deltaX > 0) { // Swiping right
                if (likeOverlay) likeOverlay.style.opacity = overlayOpacity;
                if (nopeOverlay) nopeOverlay.style.opacity = '0';
            } else if (deltaX < 0) { // Swiping left
                if (nopeOverlay) nopeOverlay.style.opacity = overlayOpacity;
                if (likeOverlay) likeOverlay.style.opacity = '0';
            } else { // No horizontal movement
                if (likeOverlay) likeOverlay.style.opacity = '0';
                if (nopeOverlay) nopeOverlay.style.opacity = '0';
            }
        }

        function onEnd(e) {
            if (!dragging || !profileCard) return;
            dragging = false;
            console.log("onEnd: Dragging ended.");

            const deltaX = (e.clientX || e.changedTouches[0].clientX) - startX;
            
            if (deltaX > THRESHOLD) {
                console.log("onEnd: Swiped right (Like).");
                performAction('like');
                animateSwipe('right', fetchNextProfile);
            } else if (deltaX < -THRESHOLD) {
                console.log("onEnd: Swiped left (Dislike).");
                performAction('dislike');
                animateSwipe('left', fetchNextProfile);
            } else {
                console.log("onEnd: No significant swipe, resetting card and overlays.");
                resetCard(); // Reset card and hide overlays
            }
        }

        // --- AJAX Function for Like/Dislike ---
        async function performAction(action) {
            if (!profileCard) {
                console.error("performAction: No profile card to get username from.");
                return;
            }
            const username = profileCard.dataset.username;
            if (!username) {
                console.error("performAction: Profile card has no username data attribute. Cannot perform action.");
                alert("Error: Cannot identify profile. Please refresh.");
                return;
            }
            console.log(`performAction: Performing '${action}' on user: ${username}`);

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`{% url 'like_user' username='DUMMY' %}`.replace('DUMMY', username), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest', // Important for Django's is_ajax() check
                        'X-CSRFToken': csrfToken,
                    },
                    body: `action=${action}` // 'like' or 'dislike'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`performAction: HTTP error! Status: ${response.status}, Response: ${errorText}`);
                    alert(`Failed to perform action: Server error ${response.status}. See console for details.`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('performAction: Server response:', data);

                if (data.status === 'matched') {
                    alert("It's a Match! 🎉 You can now message them from your Matches page.");
                } else if (data.message) {
                    console.log("performAction: Server message:", data.message);
                }

            } catch (error) {
                console.error('performAction: Error performing action:', error);
                alert("An error occurred during swipe action. Please try again.");
            }
        }

        // --- Fetch Next Profile HTML Partial via AJAX ---
        async function fetchNextProfile() {
            console.log("fetchNextProfile: Attempting to fetch next profile.");
            // Reset overlay opacities before fetching new card
            if (likeOverlay) likeOverlay.style.opacity = '0';
            if (nopeOverlay) nopeOverlay.style.opacity = '0';

            try {
                const response = await fetch(`{% url 'swipe_profiles' %}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // Identify as AJAX request
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`fetchNextProfile: HTTP error! Status: ${response.status}, Response: ${errorText}`);
                    profileCardContainer.innerHTML = `
                        <div class="text-center text-lg text-gray-600 text-red-500 w-full p-8 bg-white rounded-2xl shadow-xl">
                            <p class="mb-4">Error loading profiles. Please refresh.</p>
                            <button onclick="location.reload()" class="btn btn-secondary">Refresh Page</button>
                        </div>
                    `;
                    if (swipeButtonsDiv) swipeButtonsDiv.classList.add('hidden');
                    return;
                }

                const newHtml = await response.text();
                console.log("fetchNextProfile: Received new HTML content.");
                
                profileCardContainer.innerHTML = newHtml;
                console.log("fetchNextProfile: Container HTML updated.");
                
                // Re-bind event listeners for the newly loaded card and buttons
                rebindEventListeners();
                console.log("fetchNextProfile: rebindEventListeners called for new card.");

                // Check if a new profile card was actually loaded (i.e., not the "no more profiles" message)
                const newlyLoadedProfileCard = document.getElementById('profile-card');
                if (!newlyLoadedProfileCard || newlyLoadedProfileCard.dataset.username === undefined) {
                    console.log("fetchNextProfile: No new profile card or invalid card, displaying 'no more profiles' message. Hiding buttons.");
                    if (swipeButtonsDiv) swipeButtonsDiv.classList.add('hidden');
                    // Add a message if profileCard is null or doesn't have a username (meaning "no more profiles")
                    if (!newlyLoadedProfileCard) {
                        profileCardContainer.innerHTML = `
                            <div id="profile-card" class="absolute w-full h-full bg-white rounded-2xl shadow-xl p-6 flex flex-col items-center justify-center text-center">
                                <p class="text-gray-700 text-xl font-semibold mb-4">No more profiles to swipe on!</p>
                                <p class="text-gray-600 mb-6">Come back later or adjust your preferences.</p>
                                <a href="{% url 'browse_profiles' %}" class="btn btn-primary">Browse All Profiles</a>
                                <a href="{% url 'profile_edit' %}" class="btn btn-secondary mt-3">Edit My Preferences</a>
                            </div>
                        `;
                    }
                } else {
                    console.log("fetchNextProfile: New profile card loaded successfully.");
                }

            } catch (error) {
                console.error('fetchNextProfile: Error fetching next profile:', error);
                profileCardContainer.innerHTML = `
                    <div class="text-center text-lg text-gray-600 text-red-500 w-full p-8 bg-white rounded-2xl shadow-xl">
                        <p class="mb-4">An unexpected error occurred. Please refresh.</p>
                        <button onclick="location.reload()" class="btn btn-secondary">Refresh Page</button>
                    </div>
                `;
                if (swipeButtonsDiv) swipeButtonsDiv.classList.add('hidden');
            }
        }
    }); // End of DOMContentLoaded
</script>
{% endblock extra_js %}
